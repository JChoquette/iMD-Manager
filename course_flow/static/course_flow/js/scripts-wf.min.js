var workflow=function(t){"use strict";var e,n,i,r,s,o={},a=[],l=/acit|ex(?:s|g|n|p|$)|rph|grid|ows|mnc|ntw|ine[ch]|zoo|^ord|itera/i;function d(t,e){for(var n in e)t[n]=e[n];return t}function c(t){var e=t.parentNode;e&&e.removeChild(t)}function h(t,e,n){var i,r,s,o=arguments,a={};for(s in e)"key"==s?i=e[s]:"ref"==s?r=e[s]:a[s]=e[s];if(arguments.length>3)for(n=[n],s=3;s<arguments.length;s++)n.push(o[s]);if(null!=n&&(a.children=n),"function"==typeof t&&null!=t.defaultProps)for(s in t.defaultProps)void 0===a[s]&&(a[s]=t.defaultProps[s]);return u(t,a,i,r,null)}function u(t,n,i,r,s){var o={type:t,props:n,key:i,ref:r,__k:null,__:null,__b:0,__e:null,__d:void 0,__c:null,constructor:void 0,__v:s};return null==s&&(o.__v=o),null!=e.vnode&&e.vnode(o),o}function p(t){return t.children}function _(t,e){this.props=t,this.context=e}function f(t,e){if(null==e)return t.__?f(t.__,t.__.__k.indexOf(t)+1):null;for(var n;e<t.__k.length;e++)if(null!=(n=t.__k[e])&&null!=n.__e)return n.__e;return"function"==typeof t.type?f(t):null}function g(t){var e,n;if(null!=(t=t.__)&&null!=t.__c){for(t.__e=t.__c.base=null,e=0;e<t.__k.length;e++)if(null!=(n=t.__k[e])&&null!=n.__e){t.__e=t.__c.base=n.__e;break}return g(t)}}function v(t){(!t.__d&&(t.__d=!0)&&n.push(t)&&!m.__r++||r!==e.debounceRendering)&&((r=e.debounceRendering)||i)(m)}function m(){for(var t;m.__r=n.length;)t=n.sort((function(t,e){return t.__v.__b-e.__v.__b})),n=[],t.some((function(t){var e,n,i,r,s,o,a;t.__d&&(o=(s=(e=t).__v).__e,(a=e.__P)&&(n=[],(i=d({},s)).__v=i,r=C(a,s,i,e.__n,void 0!==a.ownerSVGElement,null,n,null==o?f(s):o),D(n,s),r!=o&&g(s)))}))}function b(t,e,n,i,r,s,l,d,h,_){var g,v,m,b,y,w,S,x=i&&i.__k||a,D=x.length;for(h==o&&(h=null!=l?l[0]:D?f(i,0):null),n.__k=[],g=0;g<e.length;g++)if(null!=(b=n.__k[g]=null==(b=e[g])||"boolean"==typeof b?null:"string"==typeof b||"number"==typeof b?u(null,b,null,null,b):Array.isArray(b)?u(p,{children:b},null,null,null):null!=b.__e||null!=b.__c?u(b.type,b.props,b.key,null,b.__v):b)){if(b.__=n,b.__b=n.__b+1,null===(m=x[g])||m&&b.key==m.key&&b.type===m.type)x[g]=void 0;else for(v=0;v<D;v++){if((m=x[v])&&b.key==m.key&&b.type===m.type){x[v]=void 0;break}m=null}y=C(t,b,m=m||o,r,s,l,d,h,_),(v=b.ref)&&m.ref!=v&&(S||(S=[]),m.ref&&S.push(m.ref,null,b),S.push(v,b.__c||y,b)),null!=y?(null==w&&(w=y),h=k(t,b,m,x,l,y,h),_||"option"!=n.type?"function"==typeof n.type&&(n.__d=h):t.value=""):h&&m.__e==h&&h.parentNode!=t&&(h=f(m))}if(n.__e=w,null!=l&&"function"!=typeof n.type)for(g=l.length;g--;)null!=l[g]&&c(l[g]);for(g=D;g--;)null!=x[g]&&T(x[g],x[g]);if(S)for(g=0;g<S.length;g++)I(S[g],S[++g],S[++g])}function k(t,e,n,i,r,s,o){var a,l,d;if(void 0!==e.__d)a=e.__d,e.__d=void 0;else if(r==n||s!=o||null==s.parentNode)t:if(null==o||o.parentNode!==t)t.appendChild(s),a=null;else{for(l=o,d=0;(l=l.nextSibling)&&d<i.length;d+=2)if(l==s)break t;t.insertBefore(s,o),a=o}return void 0!==a?a:s.nextSibling}function y(t,e,n){"-"===e[0]?t.setProperty(e,n):t[e]=null==n?"":"number"!=typeof n||l.test(e)?n:n+"px"}function w(t,e,n,i,r){var s,o;if(r&&"className"==e&&(e="class"),"style"===e)if("string"==typeof n)t.style=n;else{if("string"==typeof i&&(t.style=i=""),i)for(e in i)n&&e in n||y(t.style,e,"");if(n)for(e in n)i&&n[e]===i[e]||y(t.style,e,n[e])}else"o"===e[0]&&"n"===e[1]?(s=e!==(e=e.replace(/Capture$/,"")),(o=e.toLowerCase())in t&&(e=o),e=e.slice(2),t.l||(t.l={}),t.l[e]=n,n?i||t.addEventListener(e,S,s):t.removeEventListener(e,S,s)):"list"!==e&&"tagName"!==e&&"form"!==e&&"type"!==e&&"size"!==e&&"download"!==e&&"href"!==e&&!r&&e in t?t[e]=null==n?"":n:"function"!=typeof n&&"dangerouslySetInnerHTML"!==e&&(e!==(e=e.replace(/xlink:?/,""))?null==n||!1===n?t.removeAttributeNS("http://www.w3.org/1999/xlink",e.toLowerCase()):t.setAttributeNS("http://www.w3.org/1999/xlink",e.toLowerCase(),n):null==n||!1===n&&!/^ar/.test(e)?t.removeAttribute(e):t.setAttribute(e,n))}function S(t){this.l[t.type](e.event?e.event(t):t)}function x(t,e,n){var i,r;for(i=0;i<t.__k.length;i++)(r=t.__k[i])&&(r.__=t,r.__e&&("function"==typeof r.type&&r.__k.length>1&&x(r,e,n),e=k(n,r,r,t.__k,null,r.__e,e),"function"==typeof t.type&&(t.__d=e)))}function C(t,n,i,r,s,o,a,l,c){var h,u,f,g,v,m,k,y,w,S,C,D=n.type;if(void 0!==n.constructor)return null;(h=e.__b)&&h(n);try{t:if("function"==typeof D){if(y=n.props,w=(h=D.contextType)&&r[h.__c],S=h?w?w.props.value:h.__:r,i.__c?k=(u=n.__c=i.__c).__=u.__E:("prototype"in D&&D.prototype.render?n.__c=u=new D(y,S):(n.__c=u=new _(y,S),u.constructor=D,u.render=j),w&&w.sub(u),u.props=y,u.state||(u.state={}),u.context=S,u.__n=r,f=u.__d=!0,u.__h=[]),null==u.__s&&(u.__s=u.state),null!=D.getDerivedStateFromProps&&(u.__s==u.state&&(u.__s=d({},u.__s)),d(u.__s,D.getDerivedStateFromProps(y,u.__s))),g=u.props,v=u.state,f)null==D.getDerivedStateFromProps&&null!=u.componentWillMount&&u.componentWillMount(),null!=u.componentDidMount&&u.__h.push(u.componentDidMount);else{if(null==D.getDerivedStateFromProps&&y!==g&&null!=u.componentWillReceiveProps&&u.componentWillReceiveProps(y,S),!u.__e&&null!=u.shouldComponentUpdate&&!1===u.shouldComponentUpdate(y,u.__s,S)||n.__v===i.__v){u.props=y,u.state=u.__s,n.__v!==i.__v&&(u.__d=!1),u.__v=n,n.__e=i.__e,n.__k=i.__k,u.__h.length&&a.push(u),x(n,l,t);break t}null!=u.componentWillUpdate&&u.componentWillUpdate(y,u.__s,S),null!=u.componentDidUpdate&&u.__h.push((function(){u.componentDidUpdate(g,v,m)}))}u.context=S,u.props=y,u.state=u.__s,(h=e.__r)&&h(n),u.__d=!1,u.__v=n,u.__P=t,h=u.render(u.props,u.state,u.context),u.state=u.__s,null!=u.getChildContext&&(r=d(d({},r),u.getChildContext())),f||null==u.getSnapshotBeforeUpdate||(m=u.getSnapshotBeforeUpdate(g,v)),C=null!=h&&h.type==p&&null==h.key?h.props.children:h,b(t,Array.isArray(C)?C:[C],n,i,r,s,o,a,l,c),u.base=n.__e,u.__h.length&&a.push(u),k&&(u.__E=u.__=null),u.__e=!1}else null==o&&n.__v===i.__v?(n.__k=i.__k,n.__e=i.__e):n.__e=N(i.__e,n,i,r,s,o,a,c);(h=e.diffed)&&h(n)}catch(t){n.__v=null,e.__e(t,n,i)}return n.__e}function D(t,n){e.__c&&e.__c(n,t),t.some((function(n){try{t=n.__h,n.__h=[],t.some((function(t){t.call(n)}))}catch(t){e.__e(t,n.__v)}}))}function N(t,e,n,i,r,s,l,d){var c,h,u,p,_,f=n.props,g=e.props;if(r="svg"===e.type||r,null!=s)for(c=0;c<s.length;c++)if(null!=(h=s[c])&&((null===e.type?3===h.nodeType:h.localName===e.type)||t==h)){t=h,s[c]=null;break}if(null==t){if(null===e.type)return document.createTextNode(g);t=r?document.createElementNS("http://www.w3.org/2000/svg",e.type):document.createElement(e.type,g.is&&{is:g.is}),s=null,d=!1}if(null===e.type)f!==g&&t.data!==g&&(t.data=g);else{if(null!=s&&(s=a.slice.call(t.childNodes)),u=(f=n.props||o).dangerouslySetInnerHTML,p=g.dangerouslySetInnerHTML,!d){if(null!=s)for(f={},_=0;_<t.attributes.length;_++)f[t.attributes[_].name]=t.attributes[_].value;(p||u)&&(p&&u&&p.__html==u.__html||(t.innerHTML=p&&p.__html||""))}(function(t,e,n,i,r){var s;for(s in n)"children"===s||"key"===s||s in e||w(t,s,null,n[s],i);for(s in e)r&&"function"!=typeof e[s]||"children"===s||"key"===s||"value"===s||"checked"===s||n[s]===e[s]||w(t,s,e[s],n[s],i)})(t,g,f,r,d),p?e.__k=[]:(c=e.props.children,b(t,Array.isArray(c)?c:[c],e,n,i,"foreignObject"!==e.type&&r,s,l,o,d)),d||("value"in g&&void 0!==(c=g.value)&&c!==t.value&&w(t,"value",c,f.value,!1),"checked"in g&&void 0!==(c=g.checked)&&c!==t.checked&&w(t,"checked",c,f.checked,!1))}return t}function I(t,n,i){try{"function"==typeof t?t(n):t.current=n}catch(t){e.__e(t,i)}}function T(t,n,i){var r,s,o;if(e.unmount&&e.unmount(t),(r=t.ref)&&(r.current&&r.current!==t.__e||I(r,null,n)),i||"function"==typeof t.type||(i=null!=(s=t.__e)),t.__e=t.__d=void 0,null!=(r=t.__c)){if(r.componentWillUnmount)try{r.componentWillUnmount()}catch(t){e.__e(t,n)}r.base=r.__P=null}if(r=t.__k)for(o=0;o<r.length;o++)r[o]&&T(r[o],n,i);null!=s&&c(s)}function j(t,e,n){return this.constructor(t,n)}e={__e:function(t,e){for(var n,i;e=e.__;)if((n=e.__c)&&!n.__)try{if(n.constructor&&null!=n.constructor.getDerivedStateFromError&&(i=!0,n.setState(n.constructor.getDerivedStateFromError(t))),null!=n.componentDidCatch&&(i=!0,n.componentDidCatch(t)),i)return v(n.__E=n)}catch(e){t=e}throw t}},_.prototype.setState=function(t,e){var n;n=null!=this.__s&&this.__s!==this.state?this.__s:this.__s=d({},this.state),"function"==typeof t&&(t=t(d({},n),this.props)),t&&d(n,t),null!=t&&this.__v&&(e&&this.__h.push(e),v(this))},_.prototype.forceUpdate=function(t){this.__v&&(this.__e=!0,t&&this.__h.push(t),v(this))},_.prototype.render=p,n=[],i="function"==typeof Promise?Promise.prototype.then.bind(Promise.resolve()):setTimeout,m.__r=0,s=o;var P;const E={source:{e:[1,.6],w:[0,.6],s:[.5,1]},target:{n:[.5,0],e:[1,.4],w:[0,.4]}},O=["n","e","s","w"];function A(t,e){return t.each((t,n)=>{$(n).triggerHandler(e)})}function V(t){return t.substring(t.indexOf("translate(")+10,t.indexOf(")")).split(",")}class L{constructor(){}debounce(t,e){return function(n){let i=this.lastCall;this.lastCall=Date.now(),i&&this.lastCall-i<=e&&clearTimeout(this.lastCallTimer),this.lastCallTimer=setTimeout(()=>t(n),e)}}}class M extends _{constructor(t){super(t),this.maindiv={current:null}}componentDidMount(){this.updateJSON({},function(){this.maindiv.current&&(this.maindiv.current.react=this),this.postMountFunction(),initial_loading&&$(document).triggerHandler("component-loaded",this.objectType)}.bind(this))}updateJSON(t,e){var n=this.setState.bind(this);try{$.getJSON("/"+this.objectType+"/read/"+this.props.objectID,(function(t){n(t,e)}))}catch(t){}}postMountFunction(){}setJSON(t,e){var n={};n[t]=e,this.setState(n,()=>updateValue(this.props.objectID,this.objectType,n))}addDeleteSelf(t=this.state.id,e=this.objectType,n){return console.log(this.props.updateParent),h(W,{handleClick:deleteSelf.bind(this,t,e,()=>{this.props.updateParent({},n)})})}addInsertSibling(t=this.state.id,e=this.props.parentID,n=this.objectType,i){return h(R,{handleClick:insertSibling.bind(this,t,n,e,()=>{this.props.updateParent({},i)})})}addEditable(){if(this.state.selected){var t=this.objectType;return h("div",{class:"right-panel-container edit-bar-container"},h("div",{class:"right-panel-inner"},h("h3",null,"Edit:"),["node","strategy","column"].indexOf(t)>=0&&h("div",null,h("h4",null,"Title:"),h("input",{value:this.state.title})),["node","strategy"].indexOf(t)>=0&&h("div",null,h("h4",null,"Description:"),h("input",{value:this.state.description})),this.addDeleteSelf()))}}makeSortable(t,e,n,i,r=!1,s=!1,o="",a=!1){t.sortable({containment:".workflow-container",axis:r,cursor:"move",grid:s,cursorAt:{top:20},connectWith:o,handle:a,tolerance:"pointer",distance:10,start:(e,r)=>{t.data("last_order",t.sortable("toArray")),$(".workflow-canvas").addClass("dragging-"+n),$(i).addClass("dragging"),t.sortable("refresh");var s=$(t).sortable("instance");if(a){var o=$(s.currentItem).children(a);o=o[0],s.containment[0]-=o.offsetLeft,s.containment[2]+=s.currentItem[0].offsetWidth-o.offsetWidth-o.offsetLeft}s.containment[3]+=s.currentItem[0].offsetTop},sort:(t,e)=>{var n;(e.item.triggerHandler("dragging"),e.item.index(":not(ui-sortable-placeholder)")!=e.placeholder.index(":not(ui-sortable-helper)"))&&(e.item.parent()!=e.placeholder.parent()&&(n=e.item.siblings(i)),e.item.insertAfter(e.placeholder),n&&A(n,"sorted"),A(e.item.siblings(i),"sorted"))},remove:(e,r)=>{var s=r.item[0].id;this.childRemoved.bind(this)(n,parseInt(s)),A($(t).children(i),"sibling-removed"),A($(i).not($(t).children()),"cousin-removed")},receive:(r,s)=>{var o=s.item[0].id,a=s.item.index();s.item[0].classList.contains("node-bar-sortable")?this.newChild.bind(this)(n,e,a,s):this.childAdded.bind(this)(n,parseInt(o),a),t.children(i).triggerHandler("sibling-added"),A($(i).not(t.children()),"cousin-added")},stop:(t,r)=>{var s=r.item.attr("id"),o=r.item.index(),a=parseInt(r.item[0].parentElement.id);a&&a!=e||this.childAdded.bind(this)(n,parseInt(s),o),$(i).removeClass("dragging"),$("#container").animate({scrollTop:r.item.offset().top-200},20);var l=Math.round((r.position.left-r.originalPosition.left)/200),d=-1;if("nodestrategy"==n&&l){var c=r.item.children(".node"),h=c[0].react.state.columnworkflow;try{(d=P[P.indexOf(h)+l])&&c[0].react.setState({columnworkflow:d})}catch(t){console.log("could not change column")}}insertedAt(s,n,e,o,a,d,()=>{A($(i),"sorted"),$(".workflow-canvas").removeClass("dragging-"+n)})}})}childRemoved(t,e){try{var n=this.state[t+"_set"];n.indexOf(e)>=0&&n.splice(n.indexOf(e),1)}catch(t){}}childAdded(t,e,n){try{var i=this.state[t+"_set"];i.indexOf(e)>=0&&i.splice(i.indexOf(e),1),i.splice(n,0,e)}catch(t){}}newChild(t,e,n,i){"nodestrategy"==t&&newNode(e,n,i.item[0].sortableData.column,this.updateJSON.bind(this)),i.item.remove()}}function U(t){return h("p",null,t.text)}class J extends _{constructor(t){super(t),this.updateText=this.updateText.bind(this)}render(){var t=this.props.text;return null!=this.props.text&&""!=this.props.text||null==this.props.defaultText||(t=this.props.defaultText),this.text=t,h("input",{value:t,onBlur:this.updateText})}updateText(t){var e=t.target.value;e!=this.text&&(""==e&&(e=null),this.props.textUpdated(t.target.value))}}class W extends _{constructor(t){super(t),this.handleClick=this.handleClick.bind(this)}render(){return h("button",{class:"delete-self-button",onClick:this.handleClick},"x")}handleClick(t){this.props.handleClick(t)}}class R extends _{constructor(t){super(t),this.handleClick=this.handleClick.bind(this)}render(){return h("button",{class:"insert-sibling-button",onClick:this.handleClick},"+")}handleClick(t){this.props.handleClick(t)}}class F{constructor(t,e,n,i=2,r=0,s){this.svg=d3.select(".workflow-canvas").append("path").attr("stroke","red").attr("stroke-width","3px"),s&&this.svg.on("click",(function(){selection_manager.changeSelection(event,s)})),this.source=e,this.target=n,this.source_port=i,this.target_port=r,this.debouncer=new L,this.source_node=$("#"+e+".node"),this.source_port_handle=d3.select("g.port-"+e+" circle[data-port-type='source'][data-port='"+O[i]+"']"),this.source_node.on(this.getRerenderEvents(),this.rerender.bind(this)),this.target?this.setTarget(this.target):this.findAutoTarget(),this.target_node&&this.drawSVG(),this.eventNameSpace=t}setTarget(t){if(t){if(this.target_node&&t==this.target_node.attr("id"))return;this.target_node&&this.target_node.off(this.getRerenderEvents()),this.target_node=$("#"+t+".node"),this.target_port_handle=d3.select("g.port-"+t+" circle[data-port-type='target'][data-port='"+O[this.target_port]+"']"),this.target_node.on(this.getRerenderEvents(),this.rerender.bind(this)),this.target&&(this.target=t)}else this.target_node&&this.target_node.off(this.getRerenderEvents()),this.target_node=null,this.target_port_handle}getRerenderEvents(){return"dragging."+this.eventNameSpace+" sibling-added."+this.eventNameSpace+" sibling-removed."+this.eventNameSpace+" sorted."+this.eventNameSpace+" parent-moved."+this.eventNameSpace}findAutoTarget(){var t,e=this.source_node.closest(".node-strategy"),n=e.nextAll(":not(.ui-sortable-placeholder)").first();if(n.length>0)t=n.find(".node").attr("id");else for(var i=e.closest(".strategy-workflow").next();i.length>0&&!(t=i.find(".node").attr("id"));)i=i.next();this.setTarget(t)}rerender(){this.target||this.findAutoTarget(),this.target_node?this.drawSVG():this.hideSVG()}drawSVG(){const t=V(this.source_port_handle.select((function(){return this.parentNode})).attr("transform")),e=V(this.target_port_handle.select((function(){return this.parentNode})).attr("transform")),n=[[parseInt(this.source_port_handle.attr("cx"))+parseInt(t[0]),parseInt(this.source_port_handle.attr("cy"))+parseInt(t[1])]],i=[[parseInt(this.target_port_handle.attr("cx"))+parseInt(e[0]),parseInt(this.target_port_handle.attr("cy"))+parseInt(e[1])]];var r=this.getPath(n,i);this.svg.attr("d",r)}hideSVG(){this.svg.attr("d","")}getPath(t,e){for(var n="M",i=0;i<t.length;i++){i>0&&(n+=" L"),n+=(r=t[i])[0]+" "+r[1]}for(i=e.length-1;i>=0;i--){var r;n+=" L",n+=(r=e[i])[0]+" "+r[1]}return n}}class G extends M{constructor(t){super(t),this.objectType="nodelink"}render(){if(this.state.id)return h("div",null,this.addEditable())}postMountFunction(){initial_loading?$(document).on("render-links",this.createNodeLinkSVG.bind(this)):this.createNodeLinkSVG()}createNodeLinkSVG(){this.svg=new F("nodelink"+this.state.id,this.state.source_node,this.state.target_node,this.state.source_port,this.state.target_port,this)}componentDidUnmount(){this.svg&&d3.select(this.svg).delete()}}class H extends M{constructor(t){super(t),this.objectType="node";var e=d3.select(".workflow-canvas").append("g").attr("stroke","black").attr("fill","white").attr("stroke-width",2).attr("class","node-ports port-"+t.objectID);for(var n in E)for(var i in E[n])e.append("circle").attr("data-port-type",n).attr("data-port",i).attr("data-node-id",t.objectID).attr("r",5)}render(){if(this.state.id){var t=this.state.outgoing_links.map(t=>h(G,{key:t,objectID:t,parentID:this.state.id,updateParent:this.updateJSON.bind(this)}));return h("div",{class:"node column-"+this.state.columnworkflow+(this.state.selected?" selected":""),id:this.state.id,ref:this.maindiv,onClick:t=>selection_manager.changeSelection(t,this)},h(J,{text:this.state.title,defaultText:"New Node",textUpdated:this.setJSON.bind(this,"title")}),h(J,{text:this.state.description,textUpdated:this.setJSON.bind(this,"description")}),this.addEditable(),t)}}updatePorts(){var t=function(t){var e=t.offset(),n=$(".workflow-canvas").offset();return e.left-=n.left,e.top-=n.top,e}($(this.maindiv.current));d3.select("g.port-"+this.props.objectID).attr("transform","translate("+t.left+","+t.top+")")}placePorts(){console.log("placing ports");var t=$(this.maindiv.current),e=this,n={width:t.width(),height:t.height()};d3.selectAll("g.port-"+this.props.objectID+" circle").datum(n).each((function(t){var e=d3.select(this),n=E[e.attr("data-port-type")][e.attr("data-port")];e.attr("cx",n[0]*t.width).attr("cy",n[1]*t.height)})),d3.selectAll("g.port-"+this.props.objectID+" circle[data-port-type='source']").call(d3.drag().on("start",(function(t){var e=$(".workflow-canvas").offset();d3.select(".node-link-creator").remove(),d3.select(".workflow-canvas").append("line").attr("class","node-link-creator").attr("x1",event.x-e.left).attr("y1",event.y-e.top).attr("x2",event.x-e.left).attr("y2",event.y-e.top).attr("stroke","red").attr("stroke-width","2")})).on("drag",(function(t){var e=$(".workflow-canvas").offset();d3.select(".node-link-creator").attr("x2",event.x-e.left).attr("y2",event.y-e.top)})).on("end",(function(t){var n=d3.select(event.target);"target"==n.attr("data-port-type")&&e.nodeLinkAdded(n.attr("data-node-id"),d3.select(this).attr("data-port"),n.attr("data-port")),d3.select(".node-link-creator").remove()}))),this.updatePorts()}createNodeLinkSVG(){this.state.has_autolink&&(this.svg=new F("nodeautolink"+this.state.id,this.state.id))}nodeLinkAdded(t,e,n){if(t!=this.props.objectID)try{newNodeLink(this.props.objectID,t,O.indexOf(e),O.indexOf(n),this.updateJSON.bind(this))}catch(t){}}postMountFunction(){this.maindiv.current&&(initial_loading?(console.log("in initial loading"),$(document).on("render-ports",this.placePorts.bind(this)),$(document).on("render-links",this.createNodeLinkSVG.bind(this))):(console.log("mounted a node"),console.log(this.state.title),console.log(this.maindiv.current.parentElement.parentElement.parentElement.firstElementChild.value),this.placePorts(),this.createNodeLinkSVG()),$(this.maindiv.current).on("parent-moved sorted dragging",this.updatePorts.bind(this)))}componentDidUnmount(){console.log("unmounted"),d3.selectAll("g.port-"+this.props.objectID+" circle").delete(),this.svg&&d3.select(this.svg).delete()}}class B extends M{constructor(t){super(t),this.objectType="nodestrategy"}render(){if(this.state.id)return h("div",{class:"node-strategy",id:this.state.id,ref:this.maindiv},h(H,{updateParent:this.props.updateParent,objectID:this.state.node}))}passEventToChild(t){$(this.maindiv.current).children(".node").triggerHandler(t.type)}postMountFunction(){if(this.maindiv.current){var t=this;$(this.maindiv.current).on("sorted dragging sibling-added sibling-removed",this.updateRank.bind(this)),$(this.maindiv.current).on("parent-moved sibling-added sibling-removed cousin-added cousin-removed sorted dragging",e=>{t.passEventToChild(e)})}}updateRank(){var t=$(this.maindiv.current).index(".node-strategy:not(.ui-sortable-placeholder)");this.state.rank!=t&&this.setState({rank:t})}}class z extends M{constructor(t){super(t),this.objectType="strategy",this.node_block={current:null}}render(){if(console.log(this),this.state.id){var t=this.state.nodestrategy_set.map(t=>h(B,{key:t,objectID:t,parentID:this.state.id,updateParent:this.updateJSON.bind(this)}));return h("div",{class:"strategy"+(this.state.selected?" selected":""),ref:this.maindiv,onClick:t=>selection_manager.changeSelection(t,this)},h(J,{text:this.state.title,defaultText:this.state.strategy_type_display+" "+(this.props.rank+1),textUpdated:this.setJSON.bind(this,"title")}),h(J,{text:this.state.description,textUpdated:this.setJSON.bind(this,"description")}),h("button",{onClick:()=>newNode(this.state.id,-1,-1,this.updateJSON.bind(this))},"Add A Node"),h("div",{class:"node-block",id:this.props.objectID+"-node-block",ref:this.node_block},t),this.addEditable())}}postMountFunction(){initial_loading||A($(".strategy-workflow").not($(this.maindiv.current).parent()),"sibling-added"),this.makeSortable($(this.node_block.current),this.props.objectID,"nodestrategy",".node-strategy",!1,[200,10],".node-block",".node"),$(this.maindiv.current).on("sorted sibling-added sibling-removed",()=>{A($(this.node_block.current).children(),"parent-moved")})}}class q extends M{constructor(t){super(t),this.objectType="column"}render(){if(this.state.id){var t=this.state.title;return t||(t=this.state.column_type_display),h("div",{class:"column"+(this.state.selected?" selected":""),onClick:t=>selection_manager.changeSelection(t,this)},t,this.addEditable())}}}class K extends M{constructor(t){super(t),this.objectType="columnworkflow",$("<style>").prop("type","text/css").prop("id","column-"+this.props.objectID+"-CSS").appendTo("head")}render(){return this.state.id?(this.updateCSS(),h("div",{class:"column-workflow column-"+this.state.id,id:this.state.id,ref:this.maindiv},h(q,{objectID:this.state.column,updateParent:this.props.updateParent}),this.addDeleteSelf(this.state.column,"column",()=>A($(".column-workflow"),"sibling-removed")))):h("div",{class:"column-workflow column-"+this.state.id})}passEventToChild(t){$(this.maindiv.current).children(".column").triggerHandler(t.type)}postMountFunction(){if(this.maindiv.current){$(".column-workflow").trigger("sibling-added");var t=this;$(this.maindiv.current).on("dragging sorted sibling-added sibling-removed",this.updateRank.bind(this)),$(this.maindiv.current).on("sibling-added sibling-removed cousin-added cousin-removed sorted dragging",e=>{t.passEventToChild(e)})}}updateCSS(){$("#column-"+this.props.objectID+"-CSS").html(".column-"+this.props.objectID+"{left:"+this.calcDistance()+"px}")}updateRank(){var t=$(this.maindiv.current).index(".column-workflow:not(.ui-sortable-placeholder)");this.state.rank!=t&&this.setState({rank:t},()=>{A($(".column-"+this.props.objectID+":not(.column-workflow):not(.column)"),"parent-moved")})}calcDistance(){return 200*this.state.rank}}class Q extends M{constructor(t){super(t),this.objectType="strategyworkflow"}render(){if(this.state.id)return h("div",{class:"strategy-workflow",id:this.state.id,ref:this.maindiv},h(z,{objectID:this.state.strategy,rank:this.state.rank,updateParent:this.props.updateParent}),this.addDeleteSelf(this.state.strategy,"strategy",()=>A($(".strategy-workflow"),"sibling-removed")),this.addInsertSibling(this.state.id,this.props.parentID,"strategyworkflow"))}passEventToChild(t){$(this.maindiv.current).children(".strategy").triggerHandler(t.type)}postMountFunction(){if(this.maindiv.current){var t=this;$(this.maindiv.current).on("dragging sorted sibling-added sibling-removed",this.updateRank.bind(this)),$(this.maindiv.current).on("sibling-added sibling-removed cousin-added cousin-removed sorted dragging",e=>{t.passEventToChild(e)})}}updateRank(){var t=$(this.maindiv.current).index(".strategy-workflow:not(.ui-sortable-placeholder)");this.state.rank!=t&&this.setState({rank:t})}}class X extends M{constructor(t){super(t),this.objectType=t.type,this.nodebar={current:null}}render(){if(this.state.id){var t=this.state.columnworkflow_set.map(t=>h(K,{key:t,objectID:t,parentID:this.state.id,updateParent:this.updateJSON.bind(this)})),e=this.state.strategyworkflow_set.map(t=>h(Q,{key:t,objectID:t,parentID:this.state.id,updateParent:this.updateJSON.bind(this)})),n=this.state.columnworkflow_set.map(t=>h(Y,{key:t,objectID:t})),i=this.state.strategyworkflow_set.map(t=>h(tt,{key:t,objectID:t}));return h("div",{id:"workflow-wrapper",class:"workflow-wrapper"},h("div",{class:"workflow-container"},h(J,{text:this.state.title,textUpdated:this.setJSON.bind(this,"title")}),h(U,{text:"Created by "+this.state.author}),h(J,{text:this.state.description,textUpdated:this.setJSON.bind(this,"description")}),h("button",{onClick:()=>newColumn(this.state.id,0,this.updateJSON.bind(this))},"Add A Column"),h("div",{class:"column-row"},t),h("div",{class:"strategy-block"},e),h("svg",{class:"workflow-canvas",width:"100%",height:"100%",ref:this.nodebar})),h("div",{id:"node-bar-container",class:"node-bar-container right-panel-container"},h("div",{id:"node-bar-workflow",class:"right-panel-inner"},h("div",{class:"node-bar-column-block"},n),h("div",{class:"node-bar-strategy-block"},i))))}}postMountFunction(){this.makeSortable($(".strategy-block"),this.props.objectID,"strategyworkflow",".strategy-workflow","y"),this.makeSortable($(".column-row"),this.props.objectID,"columnworkflow",".column-workflow","x"),$(this.nodebar.current).resizable({containment:"body"})}componentDidUpdate(){this.state&&(P=this.state.columnworkflow_set)}}class Y extends M{constructor(t){super(t),this.objectType="columnworkflow"}render(){if(this.state.id)return h("div",{class:"node-bar-column-workflow",ref:this.maindiv},h(Z,{objectID:this.state.column}))}postMountFunction(){this.maindiv.current&&$(this.maindiv.current).sortable({connectWith:".node-block",helper:(t,e)=>(this.maindiv.current.copyHelper=e.clone().insertAfter(e),e.clone().appendTo(document.body)),containment:".workflow-container",start:(t,e)=>{e.item[0].sortableData={column:this.state.column}},stop:(t,e)=>{e.item[0].parentElement&&e.item[0].parentElement.classList.contains("node-bar-column-workflow")&&e.item.remove()}})}}class Z extends M{constructor(t){super(t),this.objectType="column"}render(){if(this.state){var t=this.state.title;return t||(t=this.state.column_type_display),h("div",{class:"node-bar-column node-bar-sortable"},t)}}}class tt extends M{constructor(t){super(t),this.objectType="strategyworkflow"}render(){}}return t.ClickEditText=J,t.ColumnView=q,t.ColumnWorkflowView=K,t.ComponentJSON=M,t.DeleteSelfButton=W,t.InsertSiblingButton=R,t.NodeBarColumnView=Z,t.NodeBarColumnWorkflowView=Y,t.NodeBarStrategyWorkflowView=tt,t.NodeLinkSVG=F,t.NodeLinkView=G,t.NodeStrategyView=B,t.NodeView=H,t.SelectionManager=class{constructor(){this.currentSelection,$(document).on("click",this.changeSelection.bind(this))}changeSelection(t,e){t.stopPropagation(),this.currentSelection&&this.currentSelection.setState({selected:!1}),this.currentSelection=e,this.currentSelection?(this.currentSelection.setState({selected:!0}),$("#node-bar-container").css("display","none")):$("#node-bar-container").css("display","revert")}},t.StrategyView=z,t.StrategyWorkflowView=Q,t.Text=U,t.WorkflowView=X,t.renderWorkflowView=function(t,n){!function(t,n,i){var r,l,d;e.__&&e.__(t,n),l=(r=i===s)?null:i&&i.__k||n.__k,t=h(p,null,[t]),d=[],C(n,(r?n:i||n).__k=t,l||o,o,void 0!==n.ownerSVGElement,i&&!r?[i]:l?null:n.childNodes.length?a.slice.call(n.childNodes):null,d,i||o,r),D(d,t)}(h(X,{objectID:t.id,type:t.type}),n)},t.triggerHandlerEach=A,t}({});
