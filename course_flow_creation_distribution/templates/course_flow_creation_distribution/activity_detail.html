{% load static i18n %} {% get_current_language as LANGUAGE_CODE %}

<!DOCTYPE html>
<html lang="{{LANGUAGE_CODE}}">
  <head>
    <title>{% block title %}{% endblock %}</title>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta
      name="description"
      content="{% block metadescription %}{% endblock %}"
    />
    <meta name="theme-color" content="#1976BC" />

    <!-- External resources -->
    <!-- * Fonts and icons -->
    <link
      href="https://fonts.googleapis.com/css?family=Material+Icons|Roboto|Fanwood+Text:400i|Quicksand:300,400|Rubik:200,300,300i,400"
      rel="stylesheet"
      type="text/css"
    />

    <!-- * Scripts -->
    <!-- ** Preloads -->
    <link
      rel="preload"
      href="https://cdn.polyfill.io/v2/polyfill.min.js"
      as="script"
    />
    <link rel="preload" href="https://d3js.org/d3.v5.min.js" as="script" />
    <!-- ** jquery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <!-- ** Polyfills for non-awesome browsers-->
    <script src="https://cdn.polyfill.io/v2/polyfill.min.js"></script>
    <!-- ** d3 -->
    <script
      src="https://d3js.org/d3.v5.min.js"
      defer="true"
      charset="utf-8"
    ></script>

    <!-- Internal resources -->
    <!-- * CSS -->
    <link
      rel="stylesheet"
      href="{% static 'course_flow_creation_distribution/css/base_style.css' %}"
    />
    <script src=""></script>
  </head>

  <body id="site">
    <svg id="dragdrop" width="1400" height="900"></svg>
    <footer></footer>
  </body>
  <script>
              window.addEventListener("load", function() {

                const svg = d3.select("svg").append("svg");

                const objectJson = {{ activity_json|safe }};


                const objectNodeStrategySet = objectJson.nodestrategy_set;
          /*
                    for (let i = 0; i < objectJson.nodestrategy_set.length; i++) {

                        let rect = svg.append("rect").attr("width", "120").attr("height", "45").attr("x", "6").attr("y", `${80*i}`).attr("rx", "6").attr("ry", "6").attr("class","node");

                    }
                */

                  const scC = d3.scaleOrdinal( d3.schemePastel1 );

                  const nodes = svg.selectAll('.node').data(objectNodeStrategySet).enter()
                                    .append("svg").attr("class","node")
                                    .attr("x", (d,i) => `${150*d.node.classification}`)
                                    .attr("y", (d,i) => `${80*d.rank}`);

                  nodes.append("rect").attr('x', 0).attr('y', 0).attr("rx", "6")
                      .attr("width", "120").attr("height", "45").attr("fill", (d,i) => scC(i));

                  nodes
                    .append('text')
                    .style('font-family', 'Quicksand, sans-serif')
                    .attr('class', 'node-label')
                    .attr('x', 60)
                    .attr('y', 22.5)
                    .attr('dy', 6)
                    .style('font-size', 14)
                    .attr('text-anchor', 'middle')
                    .style('fill', 'black')
                    .style('pointer-events', 'none')
                    .text(d => d.node.title);

                    function reorderByRank(previousRank, newRank){
                        nodes.each(function(d,i) { if(d.rank == newRank){
                          d.rank=previousRank;
                          d3.select(this).attr("y",`${d.rank*80}`);
                        }});
                    }

    /*

                    function linkNodes(){
                        for(let i = 0; i<nodes.length-1; i++) {
                          nodes.each(function(d,i) { if(d.rank == i){
                            svg.append()
                            d3.select(this).attr("y",`${d.rank*80}`);
                          }});
                        }
                    }

                    linkNodes();

           svg.selectAll("rect").data(objectNodeStrategySet).enter()
                      .append("rect").attr("width", "120").attr("height", "45")
                      .attr("rx", "6").attr("class","node").attr("ry", "6")
                      .attr("x", "6").attr("y", (d,i) => 80*i).attr("fill", (d,i) => scC(i));


                  svg.selectAll("text").data(objectNodeStrategySet).enter()
                      .append("text").attr("class","node").attr("x", 66)
                      .attr("y", (d,i) => 80*i+23).attr("text-anchor","middle")
                      .attr("font-size", 10).attr("fill", "black").text(d => d.node.title);
      */

                function swapDiv(elem, referenceNode){
                    referenceNode.parentNode.insertBefore(el, referenceNode.nextSibling);
                }

                function makeDragDrop() {
                  let widget = undefined;
                  let color = undefined;
                  let initRank = undefined;
                  let currentRank = undefined;
                  let initClassification = undefined;
                  let currentClassification = undefined;
                  let widgetData = undefined;

                  let drags = d3
                    .drag()
                    .on("start", function() {
                      widget = d3.select(this);
                      color = widget.select("rect").attr("fill");
                      widget.select("rect").attr("fill", "lime");
                      widgetData = widget.node().__data__;
                      initRank = widgetData.rank;
                      initClassification = widgetData.node.classification
                    })
                    .on("drag", function() {
                      widget.attr("x", d3.event.x-60).attr("y", d3.event.y-22);
                      currentRank = Math.round(widget.attr("y")/80);
                      currentClassification = Math.round(widget.attr("x")/150);
                      if(currentRank != initRank){
                          reorderByRank(initRank, currentRank);
                          widgetData.rank = currentRank;
                          initRank = currentRank;
                      }
                      if(currentClassification != initClassification){
                          widgetData.node.classification = currentClassification;
                          initClassification = currentClassification;
                      }
                    })
                    .on("end", function() {
                      if (widgetData.node.classification < 0) widgetData.node.classification = 0;
                      if (widgetData.node.classification > 2) widgetData.node.classification = 2;
                      if (widgetData.rank < 0) widgetData.rank = 0;
                      if (widgetData.rank > 6) widgetData.rank = 6;
                      widget.select("rect").attr("fill", color);
                      widget.attr("y",(d,i)=>`${d.rank*80}`)
                          .attr("x", (d,i) => `${150*d.node.classification}`);
                      console.log(objectNodeStrategySet);
                      widget = undefined;
                    });

                  drags(nodes);
                }

                makeDragDrop();
              });
  </script>
</html>
